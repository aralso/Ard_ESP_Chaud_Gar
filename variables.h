#ifndef VARIABLES_H

#define VARIABLES_H
//variables externes
#include <Preferences.h>  // Inclure la librairie nécessaire
#include <WiFi.h>
#include <OneWire.h>
#include <DallasTemperature.h>

//  -------  CONFIGURATION DES PINS -----------------------------------------------

/* PINOUT DOIT :
0: pour programmation
1: TX pour prog & debug
2: OUT2 : sortie PAC
3: RX pour prog & debug
4: OUT1 : sortie Pompe
5(pin4:markIO35): OUT3 : sortie Arret
12: IN:capteur DHT22 N°3
14: SDA Eclairs 
15: DSB1820 capteur temp piscine
17: SCL Eclairs
21-22 : SDA, SCL HDC1080
32: IN:capteur DHT22 N°2
33: IN:capteur DHT22 N°1
35:(pin17) (in only) IN : interruption éclairs
36: (in only) IN : capteur pression
39: (in only) IN
*/
/*#define BTN1 12  // Defaut secteur (pullup)
#define BTN2 13  // intrusion    (pullup)
#define BTN3 14  // autoprotection    (pullup)
#define BTN4 15  // marche/Arret    (no pull)  0V:arret 12V:marche
#define BNT5 16  // Reset pour Accesspoint*/



#ifdef MODE_WT32           // WT32_Eth01
//const int PIN_Tint = 11;   // GPIO IN1 Temp interieure DS18B20
const int PIN_Tint22 = 5;  // GPIO IN1 Temp interieure DHT22
const int PIN_PAC = 4;     // GPIO OUT PAC PWM
const int PIN_Text = 36;   //  Text:Entrée analogique 32 à 36 et 39
const int PIN_Chaudiere = 19;
#else                      // ESP32_DevKit
//const int PIN_Tint = 13;  Défini dans le fichier appli.ino
const int PIN_Tint22 = 5;     // GPIO IN1 Temp interieure DHT22
const int PIN_PAC = 4;        //  OUT PAC - PWM  40kOhm+100nF(Fc=40Hz) et PWM=40khz
const int PIN_Text = 36;      //  Text:Entrée analogique 32 à 36 et 39
const int PIN_Chaudiere = 19;
#ifdef ESP32_v1
  const int PIN_RXModbus = 16;  // s3:18  devkitv1:16 RO
  const int PIN_TXModbus = 17;  // s3:17  devkitv1:17 DI
#else
  const int PIN_RXModbus = 18;  // s3:18  devkitv1:16 RO
  const int PIN_TXModbus = 17;  // s3:17  devkitv1:17 DI
#endif
const int PIN_on = 19;   // allumage et extinction d'un système avec 2 boutons
const int PIN_off = 19;
//const int PIN_RE = 32;
//const int PIN_DE = 33;
const int PIN_RXSTM = 18;  // RX STM32
const int PIN_TXSTM = 17;  // TX STM32
#endif
//#define sorties analogique : 25 ou 26 (avec Dacwrite)

// Modbus
#ifdef ESP32_v1
  #define MAX485_RE_NEG 32  // S3:35  devkitv1:32
  #define MAX485_DE 33      // s3:36  devkitv1:33
#else
  #define MAX485_RE_NEG 35  // S3:35  devkitv1:32
  #define MAX485_DE 36      // s3:36  devkitv1:33
#endif

/* ESP32S3 : Serial0:Pin 42 et 43
*/


typedef enum {
    EVENT_NONE = 0,
    EVENT_INIT,
    EVENT_UART,
    EVENT_SENSOR,
    EVENT_GPIO_ON,
    EVENT_GPIO_OFF,
    EVENT_ERREUR,
    EVENT_ECOUTE_WebSock,
    EVENT_CYCLE_Compresseur,
    EVENT_WATCHDOG,
    EVENT_24H,
    EVENT_3min,
    EVENT_CYCLE,
    EVENT_UART1
} systeme_eve_type_t;

// Structure d'un événement tache sequenceur
typedef struct {
    systeme_eve_type_t type;  // Type d'événement
    uint32_t data;                 // Donnée associée (ex: valeur capteur, byte UART)
} systeme_eve_t;

// planning 
 #define NB_MAX_PGM  3
 typedef struct {
 	 uint8_t ch_debut;   // debut de chauffe :heure par pas de 10 minutes
	 uint8_t ch_fin;   // fin de chauffe
	 uint8_t ch_type;     // 0:tous les jours, 1:semaine, 2:week-end (2 bits)
	 uint8_t ch_consigne;  // 5° à 23°C, par pas de 0,1°C
	 uint8_t ch_cons_apres;  // 3° à 23°C, par pas de 0,5°C (6 bits)
} planning_t;

/* Codes erreur*/
#define Code_erreur_Tint 1
#define Code_erreur_Text 2
#define Code_erreur_depass_tab_status 3
#define Code_erreur_queue_full       4
#define Code_erreur_Json  5
#define Code_erreur_queue 6
#define Code_erreur_google 7
#define Code_erreur_http_local  8
#define Code_erreur_wifi  9

#define DEBOUNCE_INTERVAL 300  // Temps anti-rebond en ms

constexpr  int NB_Graphique = 6;  // Temp Ext, Temp int, Temp eau, Durée fct, durée arret, Pression 
constexpr  int NB_Val_Graph = 99;

extern uint8_t protocole;
extern WiFiClient client;
extern QueueHandle_t eventQueue;  // File d'attente des événements sequenceur
extern uint16_t erreur_queue;
extern TimerHandle_t debounceTimer;
extern uint8_t periode_cycle;
extern float Teau, Tint, Text, loi_eau_Tint, T_obj, T_loi_eau;

extern double Consigne, Input, Output;
extern double Kp, Ki, Kd;
extern uint16_t Consigne_G, Consigne_HG;
extern uint8_t HG, Ballon;
extern uint8_t mode_pid;
extern const int PIN_Tint;
extern uint8_t skip_graph;
extern uint8_t MMCh;

extern planning_t plan[];
extern uint16_t forcage_duree;
extern uint8_t forcage_consigne;
extern uint8_t ch_arret;
extern unsigned long last_chaudiere_change;
extern char mdp_routeur[16];
extern unsigned long last_remote_temp_time;

extern float  tempI_moy24h, tempE_moy24h;
extern uint8_t cpt24_Tint, cpt24_Text;

extern int16_t graphique[NB_Val_Graph][NB_Graphique];

extern Preferences preferences_nvs;  // Déclaration externe

extern uint16_t heure_arret, dernier_fct;
extern uint8_t etat_compr; 


void writeLog(uint8_t code, uint8_t c1, uint8_t c2, uint8_t c3, const char* message);
void debounceCallback(TimerHandle_t xTimer);
uint16_t crc16_arc(const uint8_t *data, size_t length);
void log_erreur(uint8_t code, uint8_t valeur, uint8_t val2);  // Code:1:Tint, 2:Text, 3:TPac;
void init_10_secondes();
void setup_0();
void setup_nvs();
void setup_1();
void setup_2();
uint8_t requete_action_appli(const char *reg, const char *data);
void appli_event_on(systeme_eve_t evt);
void appli_event_off(systeme_eve_t evt);
uint8_t requete_Get_appli (String var, float *valeur);
uint8_t requete_Set_appli (String param, int val);
uint8_t requete_GetReg_appli(int reg, float *valeur);
uint8_t requete_SetReg_appli(int param, float valeurf);
uint8_t requete_Get_String_appli(uint8_t type, String var, char *valeur);
uint8_t requete_Set_String_appli(int param, const char *texte);
uint8_t lecture_Tint(float *mesure);
uint8_t lecture_Text(float *mesure);
void event_mesure_temp();
void event_mesure_compresseur();

// Fonctions WiFi
uint8_t connectWiFiWithDiagnostic();
void diagnoseWiFiError();
void protectUARTDuringWiFi();

// Configuration DHT22
#define DHT22_TIMEOUT_MS 5000  // Timeout de lecture DHT22 en millisecondes
#define DHT22_MIN_INTERVAL_MS 2000  // Intervalle minimum entre lectures DHT22

#endif